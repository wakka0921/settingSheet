<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>セット図作成フォーム</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="form_container" class="container">    
    <h1>セット図作成フォーム</h1>

    <div class="card">
        <h3>バンド基本情報</h3>
        <div class="form-group">
            <label>バンド名</label>
            <input type="text" id="bName" placeholder="バンド名を入力">
        </div>
        <div class="form-group">
            <label>フリガナ</label>
            <input type="text" id="bHurigana" placeholder="フリガナを入力">
        </div>
        <div class="form-group">
            <label>ジャンル</label>
            <input type="text" id="bJanru" placeholder="ジャンルを入力">
        </div>
        <div class="grid-container-2col">
            <div class="form-group">
                <label>メンバー人数 (3-6人)</label>
                <select id="bMember"></select>
            </div>
            <div class="form-group">
                <label>曲数 (3-10曲)</label>
                <select id="sNumber"></select>
            </div>
        </div>
    </div>

    <div id="band_member_details" class="grid-container"></div>

    <div class="card">
        <h3>SEの有無</h3>
        <div class="radio-group">
            <label><input type="radio" name="se_exist" value="yes" checked> あり</label>
            <label><input type="radio" name="se_exist" value="no"> なし</label>
        </div>
        <div id="se_option_area">
            <div class="form-group">
                <label>登場位置</label>
                <select id="toujou_houhou">
                    <option value="板付き">板付き</option>
                    <option value="ハケ">ハケてから</option>
                </select>
            </div>
            <div class="form-group">
                <label>曲止めタイミング</label>
                <select id="stop_houhou">
                    <option value="手あげ">手上げて途中で切る</option>
                    <option value="流しきり">SE流し切り</option>
                </select>
            </div>
        </div>
    </div>

    <div id="song_details" class="grid-container"></div>

    <div class="card">
        <h3>備考欄</h3>
        <p class="note-text">
            以下項目を書いてください：<br>
            ・ギター2本の場合はどちらが上手か<br>
            ・キーボードの位置
        </p>
        <textarea id="remarks" rows="4" placeholder="備考を入力"></textarea>
    </div>

    <div class="btn-area">
        <button id="exportBtn">セット図を作成</button>
    </div>
</div>

<script>
/**
 * 1. 定数・設定
 */
const CONFIG = {
    minMembers: 3, maxMembers: 6,
    minSongs: 3, maxSongs: 10
};

/**
 * 2. フォームの動的生成
 */
document.addEventListener('DOMContentLoaded', () => {
    const memberSelect = document.getElementById('bMember');
    const songSelect = document.getElementById('sNumber');

    // 人数・曲数プルダウン生成
    for(let i=CONFIG.minMembers; i<=CONFIG.maxMembers; i++) {
        memberSelect.add(new Option(`${i}人`, i));
    }
    for(let i=CONFIG.minSongs; i<=CONFIG.maxSongs; i++) {
        songSelect.add(new Option(`${i}曲`, i));
    }

    // イベント登録
    memberSelect.addEventListener('change', renderMemberFields);
    songSelect.addEventListener('change', renderSongFields);
    document.getElementsByName('se_exist').forEach(r => r.addEventListener('change', toggleSE));

    // 初期レンダリング
    renderMemberFields();
    renderSongFields();
});

// メンバー入力欄生成
function renderMemberFields() {
    const count = document.getElementById('bMember').value;
    const container = document.getElementById('band_member_details');
    container.innerHTML = '';

    for(let i=1; i<=count; i++) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h3>メンバー ${i}</h3>
            <div class="form-group">
                <label>名前</label>
                <input type="text" id="bMemberDtl${i}" placeholder="名前を入力">
            </div>
            <div class="form-group">
                <label>担当パート</label>
                <select id="bMemberRole${i}" onchange="toggleExtraFields(${i})">
                    <option value="vo">ボーカル</option>
                    <option value="gt">ギター</option>
                    <option value="ba">ベース</option>
                    <option value="dr">ドラム</option>
                    <option value="key">キーボード</option>
                    <option value="other">その他</option>
                </select>
            </div>
            <div id="amp_area_${i}" class="extra-field" style="display:none;">
                <label>使用アンプ</label>
                <select id="bMemberAmp${i}">
                    <option value="marshall">マーシャル</option>
                    <option value="jc">JC</option>
                    <option value="other">その他</option>
                </select>
            </div>
            <div id="tamb_area_${i}" class="extra-field" style="display:none;">
                <label>タムのセット</label>
                <select id="bMemberTamb${i}">
                    <option value="10inchtamb">10インチタム残し</option>
                    <option value="12inchtamb">12インチタム残し</option>
                    <option value="2tambs">2タム</option>
                </select>
            </div>
            <div class="form-group">
                <label>役職（兼任）</label>
                <div class="radio-group">
                    <label><input type="radio" name="role_type_${i}" value="vo" checked> ボーカル</label>
                    <label><input type="radio" name="role_type_${i}" value="cho"> コーラス</label>
                </div>
            </div>
        `;
        container.appendChild(card);
    }
}

// 曲入力欄生成
function renderSongFields() {
    const count = document.getElementById('sNumber').value;
    const container = document.getElementById('song_details');
    container.innerHTML = '';

    for(let i=1; i<=count; i++) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h3>${i}曲目</h3>
            <div class="form-group">
                <label>曲名</label>
                <input type="text" id="sDetail${i}" placeholder="タイトルを入力">
            </div>
            <div class="form-group">
                <label>音響への要望</label>
                <input type="text" id="onkyo_req${i}" placeholder="例：リバーブ深め">
            </div>
            <div class="form-group">
                <label>照明への要望</label>
                <input type="text" id="shot_req${i}" placeholder="例：サビで赤く">
            </div>
        `;
        container.appendChild(card);
    }
}

// 役割に応じた追加項目の表示制御
function toggleExtraFields(index) {
    const role = document.getElementById(`bMemberRole${index}`).value;
    document.getElementById(`amp_area_${index}`).style.display = (role === 'gt') ? 'block' : 'none';
    document.getElementById(`tamb_area_${index}`).style.display = (role === 'dr') ? 'block' : 'none';
}

// SEオプションの表示制御
function toggleSE() {
    const isYes = document.querySelector('input[name="se_exist"]:checked').value === 'yes';
    document.getElementById('se_option_area').style.display = isYes ? 'block' : 'none';
}

/**
 * 3. Excel出力ロジック
 */
document.getElementById('exportBtn').addEventListener('click', async () => {
    // バリデーション
    if (!validateForm()) return;

    try {
        const resp = await fetch('セッティング図_bname.xlsx');
        if (!resp.ok) throw new Error('テンプレートが見つかりません。');
        const arrayBuffer = await resp.arrayBuffer();
        const workbook = await XlsxPopulate.fromDataAsync(arrayBuffer);
        const sheet = workbook.sheet(0);

        const getVal = id => document.getElementById(id)?.value || '';

        // 基本情報
        const bandName = getVal('bName');
        sheet.cell('G4').value(bandName);
        sheet.cell('H3').value(getVal('bHurigana'));
        sheet.cell('N4').value(getVal('bJanru'));

        // メンバー情報
        const mCount = document.getElementById('bMember').value;
        for (let i = 1; i <= mCount; i++) {
            const name = getVal(`bMemberDtl${i}`);
            const roleBase = document.getElementById(`bMemberRole${i}`).value;
            const roleSub = document.querySelector(`input[name="role_type_${i}"]:checked`).value;
            const roleDisp = `${roleBase}/${roleSub === 'vo' ? 'Vo' : 'Cho'}`;
            
            sheet.cell(`D${9+i}`).value(name);
            sheet.cell(`C${9+i}`).value(roleDisp);
        }

        // 曲情報
        const sCount = document.getElementById('sNumber').value;
        for (let j = 1; j <= sCount; j++) {
            sheet.cell(`C${22+j}`).value(j);
            sheet.cell(`D${22+j}`).value(getVal(`sDetail${j}`));
            sheet.cell(`K${22+j}`).value(getVal(`onkyo_req${j}`));
            sheet.cell(`O${22+j}`).value(getVal(`shot_req${j}`));
        }

        // 備考
        sheet.cell('Z11').value(getVal('remarks'));

        // ダウンロード処理
        const out = await workbook.outputAsync();
        const blob = new Blob([out], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `セット図_${bandName || '作成'}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
        alert('作成が完了しました。');

    } catch (err) {
        alert('エラー: ' + err.message);
    }
});

function validateForm() {
    if (!document.getElementById('bName').value) { alert('バンド名を入力してください'); return false; }
    // 3人/3曲までの名前・曲名入力チェック
    for(let i=1; i<=3; i++) {
        if(!document.getElementById(`bMemberDtl${i}`).value) { alert(`メンバー${i}の名前を入力してください`); return false; }
        if(!document.getElementById(`sDetail${i}`).value) { alert(`${i}曲目のタイトルを入力してください`); return false; }
    }
    return true;
}
</script>
</body>
</html>
